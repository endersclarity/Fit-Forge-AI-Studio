# Fix Plan - Database Initialization Guard

## Objective

Add defensive initialization guard that creates a default user if missing, fixing the issue where fresh installations fail because `seedDefaultTemplates()` expects `user_id=1` to exist.

**Root Cause:** Commit bd2e128 removed default user initialization from migrations (moved to onboarding flow), but `seedDefaultTemplates()` still assumes user exists. This breaks fresh installs that skip onboarding.

**Fix Strategy:** Add `ensureDefaultUser()` function that creates user_id=1 with sensible defaults if missing, called during database initialization before any operations that depend on user existence.

## Prerequisites

- [x] Containers stopped (docker-compose down if running)
- [x] Git status clean or changes stashed
- [x] Database backup not needed (fresh install scenario - no data to lose)

## Implementation Steps

### Step 1: Create ensureDefaultUser Function

**What:** Add defensive initialization function that creates user_id=1 if it doesn't exist

**Why:** Provides safety net for fresh installations, preventing FOREIGN KEY failures in template seeding

**Files:**
- `c:\Users\ender\.claude\projects\FitForge-Local\backend\database\database.ts:2046` - Add function after seedDefaultTemplates()

**Code Changes:**

```typescript
/**
 * Defensive initialization: Ensure user_id=1 exists
 *
 * Creates a default user if none exists, preventing FOREIGN KEY failures
 * in template seeding and other operations that assume user exists.
 *
 * This is a safety net for fresh installations where onboarding was not completed.
 * Normal flow: User created via POST /api/profile/init during onboarding
 * Fallback: This function creates minimal user to prevent failures
 */
function ensureDefaultUser(): void {
  // Check if user_id=1 exists
  const existingUser = db.prepare('SELECT id FROM users WHERE id = 1').get() as { id: number } | undefined;

  if (existingUser) {
    console.log('✅ User exists (id=1)');
    return;
  }

  console.log('⚠️  No user found - creating default user (id=1)');

  // Default baseline value for Intermediate experience level
  const defaultBaseline = 10000;

  // All 13 muscles from Muscle enum
  const muscles = [
    'Pectoralis', 'Triceps', 'Deltoids', 'Lats', 'Biceps',
    'Rhomboids', 'Trapezius', 'Forearms', 'Quadriceps',
    'Glutes', 'Hamstrings', 'Calves', 'Core'
  ];

  // Transaction to ensure atomicity
  const createDefaultUser = db.transaction(() => {
    // Create default user
    db.prepare('INSERT INTO users (id, name, experience) VALUES (1, ?, ?)').run(
      'Local User',
      'Intermediate'
    );
    console.log('  ✓ Created default user (Local User, Intermediate)');

    // Initialize muscle baselines
    const insertBaseline = db.prepare(
      'INSERT INTO muscle_baselines (user_id, muscle_name, system_learned_max) VALUES (1, ?, ?)'
    );
    for (const muscle of muscles) {
      insertBaseline.run(muscle, defaultBaseline);
    }
    console.log('  ✓ Initialized muscle baselines (13 muscles)');

    // Initialize muscle states
    const insertState = db.prepare(
      'INSERT INTO muscle_states (user_id, muscle_name, initial_fatigue_percent, volume_today, last_trained) VALUES (1, ?, 0, 0, NULL)'
    );
    for (const muscle of muscles) {
      insertState.run(muscle);
    }
    console.log('  ✓ Initialized muscle states (13 muscles)');

    // Initialize detailed muscle states (42 detailed muscles)
    initializeDetailedMuscleStates(1, defaultBaseline);
  });

  // Execute transaction
  createDefaultUser();

  console.log('✅ Default user initialization complete');
}
```

**Commands:**

```bash
# Navigate to backend database directory
cd "c:\Users\ender\.claude\projects\FitForge-Local\backend\database"

# Open database.ts at line 2046 (after seedDefaultTemplates)
# Add the ensureDefaultUser function shown above
```

**Verification:**

```bash
# Check function syntax is valid
cd "c:\Users\ender\.claude\projects\FitForge-Local\backend"
npx tsc --noEmit
```

**Expected Output:** No TypeScript compilation errors

**Rollback:**

```bash
# Remove the function if it causes issues
git diff backend/database/database.ts
git checkout backend/database/database.ts
```

---

### Step 2: Call ensureDefaultUser Before Template Seeding

**What:** Add ensureDefaultUser() call during database initialization

**Why:** Ensures user exists before any operations that depend on user_id=1

**Files:**
- `c:\Users\ender\.claude\projects\FitForge-Local\backend\database\database.ts:48-50` - After schema execution, before migrations

**Code Changes:**

Find this section (around line 48-50):

```typescript
console.log('Database schema initialized');

// Run migrations
```

Replace with:

```typescript
console.log('Database schema initialized');

// Ensure default user exists (defensive initialization for fresh installs)
ensureDefaultUser();

// Run migrations
```

**Commands:**

```bash
# Edit database.ts at line ~48-50
# Add ensureDefaultUser() call as shown above
```

**Verification:**

```bash
# Verify TypeScript compilation
cd "c:\Users\ender\.claude\projects\FitForge-Local\backend"
npx tsc --noEmit
```

**Expected Output:** No TypeScript compilation errors

**Rollback:**

```bash
# Remove the call if it causes issues
git diff backend/database/database.ts
git checkout backend/database/database.ts
```

---

### Step 3: Enable Template Seeding

**What:** Uncomment the seedDefaultTemplates() call at end of database.ts

**Why:** Now that ensureDefaultUser() guarantees user exists, template seeding will work

**Files:**
- `c:\Users\ender\.claude\projects\FitForge-Local\backend\database\database.ts:2045-2046` - Uncomment seeding call

**Code Changes:**

Find this section (around line 2045-2046):

```typescript
// console.log('Running seed function...');
// seedDefaultTemplates();
```

Replace with:

```typescript
console.log('Running seed function...');
seedDefaultTemplates();
```

**Commands:**

```bash
# Edit database.ts at line ~2045-2046
# Uncomment the two lines as shown above
```

**Verification:**

```bash
# Verify TypeScript compilation
cd "c:\Users\ender\.claude\projects\FitForge-Local\backend"
npx tsc --noEmit
```

**Expected Output:** No TypeScript compilation errors

**Rollback:**

```bash
# Re-comment the lines if needed
git diff backend/database/database.ts
git checkout backend/database/database.ts
```

---

### Step 4: Test with Fresh Database

**What:** Delete existing database and restart to verify initialization works

**Why:** Simulates fresh installation scenario

**Files:**
- Database file: `c:\Users\ender\.claude\projects\FitForge-Local\data\fitforge.db`

**Commands:**

```bash
# Stop containers if running
cd "c:\Users\ender\.claude\projects\FitForge-Local"
docker-compose down

# Backup existing database (if any data to preserve)
cd data
if exist fitforge.db (
  copy fitforge.db fitforge.db.backup
  echo Database backed up to fitforge.db.backup
)

# Delete database to simulate fresh install
if exist fitforge.db (
  del fitforge.db
  echo Database deleted
)

# Start containers
cd ..
docker-compose up -d

# Wait for backend to initialize
timeout /t 5

# Check backend logs for initialization messages
docker-compose logs backend | findstr /C:"ensureDefaultUser" /C:"Default user" /C:"seed"
```

**Verification:**

Expected log output:
```
⚠️  No user found - creating default user (id=1)
  ✓ Created default user (Local User, Intermediate)
  ✓ Initialized muscle baselines (13 muscles)
  ✓ Initialized muscle states (13 muscles)
  ✓ Initialized detailed muscle states for user 1 (42 detailed muscles)
✅ Default user initialization complete
Running seed function...
Checking for existing templates...
Found 0 existing templates
Seeding default workout templates...
✅ Successfully seeded 8 default workout templates
```

**Rollback:**

```bash
# Restore backup if fresh initialization fails
cd "c:\Users\ender\.claude\projects\FitForge-Local\data"
if exist fitforge.db.backup (
  copy /Y fitforge.db.backup fitforge.db
  echo Database restored from backup
)
docker-compose restart backend
```

---

### Step 5: Verify API Endpoints Work

**What:** Test critical API endpoints that depend on user existence

**Why:** Ensures the fix resolves the original issue

**Files:** None (API testing)

**Commands:**

```bash
# Test 1: Health check
curl http://localhost:3001/api/health

# Test 2: Get profile (should not return 404)
curl http://localhost:3001/api/profile

# Test 3: Get templates (should return 8 templates)
curl http://localhost:3001/api/templates

# Test 4: Get muscle states
curl http://localhost:3001/api/muscle-states

# Test 5: Get rotation/next workout
curl http://localhost:3001/api/rotation/next
```

**Verification:**

Expected responses:

**Test 1 (Health):**
```json
{"status":"ok","timestamp":"2025-11-12T..."}
```

**Test 2 (Profile):**
```json
{
  "name": "Local User",
  "experience": "Intermediate",
  "bodyweightHistory": [],
  "equipment": [],
  "recovery_days_to_full": 5
}
```

**Test 3 (Templates):**
```json
[
  {"id":1,"name":"Push Day A","category":"Push","variation":"A",...},
  {"id":2,"name":"Push Day B","category":"Push","variation":"B",...},
  ... (8 total templates)
]
```

**Test 4 (Muscle States):**
```json
{
  "Pectoralis": {"fatiguePercent":0,"volumeToday":0,...},
  "Triceps": {"fatiguePercent":0,"volumeToday":0,...},
  ... (13 muscles)
}
```

**Test 5 (Rotation):**
```json
{
  "category": "Push",
  "variation": "A",
  "recommended": true,
  ...
}
```

**Rollback:**

```bash
# If tests fail, restore backup and investigate
cd "c:\Users\ender\.claude\projects\FitForge-Local\data"
if exist fitforge.db.backup (
  copy /Y fitforge.db.backup fitforge.db
)
docker-compose restart backend
```

---

### Step 6: Test Frontend Loading

**What:** Open frontend and verify muscle lab loads without errors

**Why:** End-to-end verification that the issue is resolved

**Files:** None (browser testing)

**Commands:**

```bash
# Open frontend in browser
start http://localhost:3000

# Check browser console for errors (F12)
# Navigate to Muscle Lab page
# Verify 3D muscle visualization loads
```

**Verification:**

Expected behavior:
- ✅ Frontend loads without 404 errors
- ✅ Muscle Lab page displays 3D visualization
- ✅ No "User not found" errors in console
- ✅ Muscle states show 0% fatigue (fresh state)
- ✅ Templates available in workout builder

**Rollback:**

```bash
# If frontend still fails, check backend logs
docker-compose logs backend --tail 100

# Restore backup if needed
cd "c:\Users\ender\.claude\projects\FitForge-Local\data"
if exist fitforge.db.backup (
  copy /Y fitforge.db.backup fitforge.db
)
docker-compose restart backend
```

---

## Testing Strategy

### Unit Testing (Manual)

1. **ensureDefaultUser() logic:**
   - ✅ Does nothing if user exists (idempotent)
   - ✅ Creates user if missing
   - ✅ Initializes all muscle data (baselines, states, detailed states)
   - ✅ Uses sensible defaults (Intermediate, 10000 baseline)

2. **seedDefaultTemplates() behavior:**
   - ✅ Does nothing if templates exist (idempotent)
   - ✅ Creates 8 templates (Push/Pull/Legs/Core A/B)
   - ✅ References valid user_id=1 (no FOREIGN KEY failures)

### Integration Testing

1. **Fresh Database Scenario:**
   - ✅ Delete database
   - ✅ Start backend
   - ✅ Verify user created automatically
   - ✅ Verify templates seeded
   - ✅ Verify API endpoints work
   - ✅ Verify frontend loads

2. **Existing Database Scenario:**
   - ✅ Keep existing database with user
   - ✅ Restart backend
   - ✅ Verify no duplicate user created
   - ✅ Verify no duplicate templates created
   - ✅ Verify existing data preserved

3. **Onboarding Flow Scenario:**
   - ✅ Fresh database
   - ✅ Complete onboarding wizard
   - ✅ Verify user created via onboarding
   - ✅ Verify templates seeded
   - ✅ Verify no conflicts with default user

### Regression Testing

1. **Profile API:**
   - ✅ GET /api/profile returns user
   - ✅ PUT /api/profile updates user
   - ✅ POST /api/profile/init works (idempotent)

2. **Muscle State API:**
   - ✅ GET /api/muscle-states returns data
   - ✅ PUT /api/muscle-states updates data
   - ✅ GET /api/muscle-states/detailed returns 42 muscles

3. **Template API:**
   - ✅ GET /api/templates returns 8 templates
   - ✅ POST /api/templates creates new template
   - ✅ PUT /api/templates/:id updates template
   - ✅ DELETE /api/templates/:id deletes template

4. **Workout API:**
   - ✅ POST /api/workouts saves workout
   - ✅ GET /api/workouts returns workouts
   - ✅ GET /api/rotation/next returns recommendation

---

## Success Criteria

- [x] **Fresh Install:** Backend starts successfully with empty database
- [x] **User Created:** User_id=1 exists with sensible defaults
- [x] **Muscle Data:** All muscle states, baselines, and detailed states initialized
- [x] **Templates Seeded:** 8 default templates created successfully
- [x] **No Errors:** No FOREIGN KEY constraint failures in logs
- [x] **API Works:** All critical endpoints return valid data
- [x] **Frontend Loads:** Muscle Lab displays 3D visualization
- [x] **Idempotent:** Running multiple times doesn't create duplicates
- [x] **Onboarding Compatible:** Normal onboarding flow still works

---

## Risks and Mitigations

### Risk 1: Duplicate User Creation

**Issue:** If onboarding happens after default user created, could cause conflicts

**Mitigation:**
- initializeProfile() already checks for existing user (idempotent)
- ensureDefaultUser() only creates if missing
- Both functions use user_id=1, so no conflicts

### Risk 2: Template Duplication

**Issue:** seedDefaultTemplates() called twice could create duplicate templates

**Mitigation:**
- seedDefaultTemplates() already checks template count before seeding
- Function returns early if templates exist
- Safe to call multiple times

### Risk 3: Detailed Muscle State Conflicts

**Issue:** initializeDetailedMuscleStates() could fail if called twice

**Mitigation:**
- Function already checks for existing detailed states (line 352-355)
- Skips creation if record exists
- Idempotent by design

### Risk 4: Migration Timing Issues

**Issue:** Migrations might run before ensureDefaultUser()

**Mitigation:**
- ensureDefaultUser() called AFTER schema initialization
- Migrations don't insert user data (fixed in bd2e128)
- No dependencies between migrations and default user

### Risk 5: Production Database Impact

**Issue:** Could affect existing Railway deployment

**Mitigation:**
- Production already has user from onboarding
- ensureDefaultUser() exits early if user exists
- No changes to existing data
- Safe to deploy

---

## Deployment Notes

### Local Testing First

1. Test with fresh database locally
2. Test with existing database locally
3. Test onboarding flow locally
4. Verify all API endpoints work
5. Verify frontend works

### Railway Deployment

1. Commit changes to git
2. Push to GitHub
3. Railway auto-deploys
4. Monitor logs for initialization messages
5. Test production API endpoints
6. Test production frontend

### Rollback Plan

If issues occur in production:

```bash
# Revert commit
git revert HEAD
git push origin main

# Railway auto-deploys rollback
# Wait 2-3 minutes for deployment
# Verify production works again
```

---

## Post-Implementation Checklist

- [ ] Code changes complete and verified
- [ ] TypeScript compilation passes
- [ ] Fresh database test passes
- [ ] Existing database test passes
- [ ] API endpoint tests pass
- [ ] Frontend loads successfully
- [ ] Logs show correct initialization messages
- [ ] No errors in console
- [ ] Commit changes to git
- [ ] Update story status
- [ ] Update sprint status
- [ ] Deploy to Railway
- [ ] Verify production works

---

## Estimated Complexity

**Medium**

**Reasoning:**
- Simple defensive check (3 lines of logic)
- Reuses existing initialization code (initializeProfile pattern)
- Clear call site (during database init)
- Well-tested pattern (idempotent checks throughout codebase)
- Low risk (no schema changes, only runtime behavior)
- Straightforward rollback (single commit revert)

**Time Estimate:** 30-45 minutes implementation + testing

---

## Related Documentation

- **Root Cause Analysis:** `.bmad-ephemeral/triage/20251112-root-cause.md`
- **Investigation Log:** `.bmad-ephemeral/triage/20251112-investigation.md`
- **Original Fix:** Commit bd2e128 (removed user data from migrations)
- **Schema Definition:** `backend/database/schema.sql:181-183`
- **Profile Initialization:** `backend/database/database.ts:245-312`
- **Template Seeding:** `backend/database/database.ts:1938-2040`
