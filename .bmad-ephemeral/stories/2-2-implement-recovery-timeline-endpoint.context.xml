<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Implement Recovery Timeline Endpoint</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/2-2-implement-recovery-timeline-endpoint.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>frontend application</asA>
    <iWant>to fetch current recovery state for all muscles</iWant>
    <soThat>users can see recovery progress and predictions</soThat>
    <tasks>
      - Task 1: Create GET endpoint structure (AC: 1)
        - Subtask 1.1: Add route definition `GET /api/recovery/timeline` in `backend/server.ts`
        - Subtask 1.2: Define TypeScript response interface: `RecoveryTimelineResponse` with muscles array containing name, currentFatigue, projections, fullyRecoveredAt
        - Subtask 1.3: Add error handling middleware pattern matching existing endpoints
        - Subtask 1.4: Handle edge case where no workout history exists (return all muscles at 0% fatigue)

      - Task 2: Query latest muscle states (AC: 1)
        - Subtask 2.1: Query database for latest `muscle_states` record for each of 15 muscles using `database.js`
        - Subtask 2.2: Get current timestamp for recovery calculations
        - Subtask 2.3: Handle case where some muscles have no workout history (treat as 0% fatigue)
        - Subtask 2.4: Validate muscle_states data structure matches expected format

      - Task 3: Calculate recovery for each muscle (AC: 2, 3, 4, 5)
        - Subtask 3.1: Import `recoveryCalculator.js` service (from Story 1.2)
        - Subtask 3.2: For each muscle, call recovery service with current state and timestamp
        - Subtask 3.3: Get current fatigue percentage from recovery calculation
        - Subtask 3.4: Get recovery projections at 24h, 48h, 72h intervals
        - Subtask 3.5: Determine `fullyRecoveredAt` timestamp (when fatigue reaches 0%)
        - Subtask 3.6: Handle service errors and return 500 on calculation failure

      - Task 4: Format and return response (AC: 3, 4, 5)
        - Subtask 4.1: Build response array with all 15 muscles
        - Subtask 4.2: For each muscle include: name, currentFatigue, projections (24h/48h/72h), fullyRecoveredAt
        - Subtask 4.3: Sort muscles by recovery priority (most fatigued first)
        - Subtask 4.4: Return 200 status with complete RecoveryTimelineResponse
        - Subtask 4.5: Ensure response matches expected format for frontend consumption

      - Task 5: Add comprehensive endpoint tests (Testing)
        - Subtask 5.1: Test successful timeline fetch with workout history
        - Subtask 5.2: Test recovery calculation integration (service called correctly for all muscles)
        - Subtask 5.3: Test current fatigue values are accurate
        - Subtask 5.4: Test 24h/48h/72h projections calculated correctly
        - Subtask 5.5: Test fullyRecoveredAt timestamp accuracy
        - Subtask 5.6: Test edge case: no workout history (all muscles at 0%)
        - Subtask 5.7: Test edge case: some muscles worked, others not (mixed states)
        - Subtask 5.8: Test 500 error when calculation service fails
    </tasks>
  </story>

  <acceptanceCriteria>
    1. **Given** a user with workout history
       **When** GET request sent to `/api/recovery/timeline`
       **Then** the endpoint queries latest muscle states from database

    2. **And** it calls recovery calculation service for each muscle

    3. **And** it returns current fatigue levels

    4. **And** it returns recovery projections at 24h, 48h, 72h

    5. **And** it identifies when each muscle will be fully recovered
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 2: API Integration Layer</title>
        <section>Story 2.2: Implement Recovery Timeline Endpoint</section>
        <snippet>GET endpoint `/api/recovery/timeline` queries latest muscle states, calls recovery calculation service, returns current fatigue, 24h/48h/72h projections, and full recovery timestamps. Edge case: No workout history returns all muscles at 0% fatigue. Cache considerations: Recovery state changes over time, keep cache short.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>FitForge Architecture</title>
        <section>API Response Format and Database Access</section>
        <snippet>Direct JSON responses (no wrapper). All DB operations through database.js. API URL pattern: `/api/resource/:id/action`. Error handling: Throw in services, catch in routes. Backend uses Express + SQLite via better-sqlite3.</snippet>
      </doc>
      <doc>
        <path>backend/database/schema.sql</path>
        <title>Database Schema</title>
        <section>muscle_states table</section>
        <snippet>Table stores: user_id, muscle_name, initial_fatigue_percent (0-100), volume_today, last_trained (ISO 8601), updated_at. Unique constraint on (user_id, muscle_name). Used to track current fatigue state per muscle group.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/2-1-implement-workout-completion-endpoint.md</path>
        <title>Story 2.1 Learnings</title>
        <section>Dev Notes - Learnings from Previous Story</section>
        <snippet>Established endpoint pattern: TypeScript interfaces, comprehensive validation, service integration via imports, error handling (400/404/500). Epic 1 services available: calculateRecovery() from recoveryCalculator.js. Database pattern: All DB ops through database.js. Module pattern: ES6 imports for services. Test framework: Vitest with mocking.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/services/recoveryCalculator.js</path>
        <kind>service</kind>
        <symbol>calculateRecovery</symbol>
        <lines>185-230</lines>
        <reason>Core recovery calculation service. Takes muscleStates array, workoutTimestamp, currentTime. Returns recovery state with currentFatigue, projections (24h/48h/72h), and fullyRecoveredAt timestamp. Linear recovery model: 15% per 24 hours.</reason>
      </artifact>
      <artifact>
        <path>backend/services/recoveryCalculator.js</path>
        <kind>service</kind>
        <symbol>calculateMuscleRecovery</symbol>
        <lines>102-132</lines>
        <reason>Single muscle recovery calculation helper. Used internally by calculateRecovery. Returns formatted recovery state for one muscle.</reason>
      </artifact>
      <artifact>
        <path>backend/database/database.js</path>
        <kind>database-layer</kind>
        <symbol>getMuscleStates</symbol>
        <lines>265-283</lines>
        <reason>Queries latest muscle_states for all muscles. Returns object with muscle names as keys, containing fatiguePercent, volumeToday, recoveredAt, lastTrained. Primary data source for endpoint.</reason>
      </artifact>
      <artifact>
        <path>backend/server.ts</path>
        <kind>endpoint</kind>
        <symbol>GET /api/recovery/timeline</symbol>
        <lines>1135-1188</lines>
        <reason>EXISTING endpoint implementation. Currently uses old recoveryCalculator interface. Needs refactoring to match Story 1.2 service contract with correct parameter order and response format.</reason>
      </artifact>
      <artifact>
        <path>backend/server.ts</path>
        <kind>endpoint</kind>
        <symbol>POST /api/workouts/:id/complete</symbol>
        <lines>1021-1134</lines>
        <reason>Reference implementation for Story 2.1. Shows TypeScript interface pattern, service integration, error handling, and response format to follow.</reason>
      </artifact>
      <artifact>
        <path>backend/server.ts</path>
        <kind>endpoint</kind>
        <symbol>GET /api/muscle-states</symbol>
        <lines>378-398</lines>
        <reason>Reference GET endpoint showing database query pattern and simple response formatting.</reason>
      </artifact>
      <artifact>
        <path>backend/__tests__/workoutCompletion.test.ts</path>
        <kind>test</kind>
        <symbol>workout completion tests</symbol>
        <lines>1-end</lines>
        <reason>Reference test pattern for endpoint testing. Shows Vitest setup, mocking strategy, test cases structure for Story 2.1 endpoint.</reason>
      </artifact>
    </code>
    <dependencies>
      <nodejs>
        <package name="express" use="Web framework for API endpoints" />
        <package name="better-sqlite3" use="SQLite database driver" />
        <package name="typescript" version="~5.8.2" use="Type safety for server.ts" />
        <package name="vitest" version="^4.0.3" use="Test framework" />
      </nodejs>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Endpoint MUST be added to backend/server.ts (existing file - additive change only)</constraint>
    <constraint>Use TypeScript for type safety - define RecoveryTimelineResponse interface inline</constraint>
    <constraint>All database operations MUST go through database.js (never direct SQL in endpoints)</constraint>
    <constraint>Import recoveryCalculator service: import { calculateRecovery } from './services/recoveryCalculator.js'</constraint>
    <constraint>Error handling: Try/catch blocks wrap service calls, return 500 with { error: "message" } on failure</constraint>
    <constraint>Response format: Direct JSON response (no wrapper), matches existing endpoint pattern</constraint>
    <constraint>Handle edge case: No workout history returns all 15 muscles at 0% fatigue with null fullyRecoveredAt</constraint>
    <constraint>Sort muscles by current fatigue (most fatigued first) for better UX</constraint>
    <constraint>Use ES6 module imports (not CommonJS) for TypeScript files</constraint>
    <constraint>15 Muscle Groups (validate consistency): Pectoralis, Lats, AnteriorDeltoids, PosteriorDeltoids, Trapezius, Rhomboids, LowerBack, Core, Biceps, Triceps, Forearms, Quadriceps, Hamstrings, Glutes, Calves</constraint>
    <constraint>Test framework: Vitest (matches Epic 1 services and Story 2.1 endpoint tests)</constraint>
    <constraint>Test location: backend/__tests__/recoveryTimeline.test.ts</constraint>
    <constraint>Mock strategy: Mock calculateRecovery service and database.js for unit tests</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>RecoveryTimelineResponse (TypeScript Interface)</name>
      <kind>Response Type Definition</kind>
      <signature>interface RecoveryTimelineResponse {
  muscles: MuscleRecoveryState[];
}

interface MuscleRecoveryState {
  name: string;
  currentFatigue: number;
  projections: {
    "24h": number;
    "48h": number;
    "72h": number;
  };
  fullyRecoveredAt: string | null;
}</signature>
      <path>backend/server.ts</path>
    </interface>
    <interface>
      <name>calculateRecovery (Service Function)</name>
      <kind>Service Function Signature</kind>
      <signature>function calculateRecovery(
  muscleStates: Array&lt;{ muscle: string, fatiguePercent: number }&gt;,
  workoutTimestamp: string,
  currentTime: string
): {
  muscleStates: Array&lt;{
    muscle: string,
    currentFatigue: number,
    projections: { "24h": number, "48h": number, "72h": number },
    fullyRecoveredAt: string | null
  }&gt;,
  timestamp: string
}</signature>
      <path>backend/services/recoveryCalculator.js</path>
    </interface>
    <interface>
      <name>getMuscleStates (Database Function)</name>
      <kind>Database Query Function</kind>
      <signature>function getMuscleStates(): Record&lt;string, {
  fatiguePercent: number,
  volumeToday: number,
  recoveredAt: string | null,
  lastTrained: string | null
}&gt;</signature>
      <path>backend/database/database.js</path>
    </interface>
    <interface>
      <name>GET /api/recovery/timeline</name>
      <kind>REST API Endpoint</kind>
      <signature>GET /api/recovery/timeline
Request: None (GET endpoint)
Response 200: RecoveryTimelineResponse
Response 500: { error: string }</signature>
      <path>backend/server.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Vitest test framework (established in Epic 1 and Story 2.1). Unit tests mock services and database for isolated testing. Integration tests use real services. Test files in backend/__tests__/ directory. Pattern: describe blocks for feature grouping, it/test for individual cases. Mock strategy: vi.mock() for modules, vi.fn() for functions. Assertions use expect() with Vitest matchers. Test coverage includes happy path, edge cases, and error scenarios.</standards>
    <locations>backend/__tests__/recoveryTimeline.test.ts (new file to create)</locations>
    <ideas>
      <idea ac="1">Test successful timeline fetch with workout history - verify database query called, recovery service called for each muscle, 200 response returned</idea>
      <idea ac="2,3,4,5">Test recovery calculation integration - verify calculateRecovery service called correctly with muscle states, workout timestamp, current time. Verify response includes currentFatigue, projections (24h/48h/72h), fullyRecoveredAt for each muscle</idea>
      <idea ac="3">Test current fatigue values are accurate - mock muscle states with known fatigue, verify endpoint returns calculated current fatigue</idea>
      <idea ac="4">Test 24h/48h/72h projections calculated correctly - verify projection values match expected recovery decay (15% per 24h)</idea>
      <idea ac="5">Test fullyRecoveredAt timestamp accuracy - verify timestamp when fatigue reaches 0% is calculated correctly</idea>
      <idea ac="1">Test edge case: no workout history (empty muscle_states) - verify all 15 muscles returned at 0% fatigue with null fullyRecoveredAt</idea>
      <idea ac="1">Test edge case: some muscles worked, others not (mixed states) - verify muscles with no history show 0%, muscles with history show calculated values</idea>
      <idea ac="2">Test 500 error when calculation service fails - mock calculateRecovery to throw error, verify 500 status and error message returned</idea>
      <idea>Test response structure matches RecoveryTimelineResponse interface - verify muscles array, each muscle has name, currentFatigue, projections, fullyRecoveredAt</idea>
      <idea>Test muscles sorted by fatigue (most fatigued first) - verify response array order</idea>
      <idea>Test all 15 muscle groups included - verify complete muscle coverage in response</idea>
    </ideas>
  </tests>
</story-context>
