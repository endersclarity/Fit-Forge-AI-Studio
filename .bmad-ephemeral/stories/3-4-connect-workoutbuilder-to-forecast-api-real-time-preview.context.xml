<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>4</storyId>
    <title>Connect WorkoutBuilder to Forecast API (Real-Time Preview)</title>
    <status>drafted</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/3-4-connect-workoutbuilder-to-forecast-api-real-time-preview.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to see predicted muscle fatigue as I add exercises</iWant>
    <soThat>I can plan balanced workouts without trial and error</soThat>
    <tasks>
      <task id="1" status="pending">Replace local forecast calculation with API integration (AC: 1, 2)
        <subtask id="1.1">Locate WorkoutBuilder.tsx component (components/WorkoutBuilder.tsx)</subtask>
        <subtask id="1.2">Add state variables for forecastData, isForecastLoading, and error</subtask>
        <subtask id="1.3">Create fetchForecast async function with debouncing (500ms delay)</subtask>
        <subtask id="1.4">Implement POST request to /api/forecast/workout endpoint</subtask>
        <subtask id="1.5">Replace local calculateForecastedMuscleStates() at line 253 with API call</subtask>
        <subtask id="1.6">Add TypeScript type definitions for API request/response structure</subtask>
      </task>
      <task id="2" status="pending">Implement data formatting helper for API request (AC: 1)
        <subtask id="2.1">Create formatSetsForAPI() function</subtask>
        <subtask id="2.2">Group workout.sets by exerciseId into Map</subtask>
        <subtask id="2.3">Transform Set objects to { reps, weight } arrays</subtask>
        <subtask id="2.4">Convert Map to API format Array&lt;{ exerciseId, estimatedSets }&gt;</subtask>
        <subtask id="2.5">Handle empty workout.sets array (return early, no API call)</subtask>
      </task>
      <task id="3" status="pending">Trigger forecast on workout changes with debouncing (AC: 5)
        <subtask id="3.1">Create debounced fetchForecast using useMemo with lodash/debounce</subtask>
        <subtask id="3.2">Add useEffect watching workout.sets and mode state</subtask>
        <subtask id="3.3">Call fetchForecast(workout.sets) only when mode === 'planning'</subtask>
        <subtask id="3.4">Cleanup debounce on unmount with fetchForecast.cancel()</subtask>
        <subtask id="3.5">Set 500ms debounce delay to avoid excessive API calls</subtask>
      </task>
      <task id="4" status="pending">Create forecast display panel UI (AC: 3, 6)
        <subtask id="4.1">Add forecast panel section in planning mode UI</subtask>
        <subtask id="4.2">Show "Calculating..." message when isForecastLoading === true</subtask>
        <subtask id="4.3">Show "Add exercises to see forecast" when !forecastData</subtask>
        <subtask id="4.4">Display muscle fatigue grid with Object.entries(forecastData.forecast)</subtask>
        <subtask id="4.5">Show muscle name and fatigue percentage for each muscle</subtask>
        <subtask id="4.6">Apply color-coded styling using getFatigueColorClass() helper</subtask>
      </task>
      <task id="5" status="pending">Implement color-coded fatigue display (AC: 6)
        <subtask id="5.1">Create getFatigueColorClass(fatigue: number) helper function</subtask>
        <subtask id="5.2">Return 'bg-red-900 text-white' for fatigue &gt; 100 (dark red - bottleneck)</subtask>
        <subtask id="5.3">Return 'bg-red-700 text-white' for fatigue &gt; 90 (red - high intensity)</subtask>
        <subtask id="5.4">Return 'bg-yellow-600 text-white' for fatigue &gt; 60 (yellow - moderate)</subtask>
        <subtask id="5.5">Return 'bg-green-600 text-white' for fatigue &lt;= 60 (green - safe)</subtask>
      </task>
      <task id="6" status="pending">Display bottleneck warnings (AC: 4, 7)
        <subtask id="6.1">Check if forecastData.bottlenecks.length &gt; 0</subtask>
        <subtask id="6.2">Render warning section below forecast grid</subtask>
        <subtask id="6.3">Map over bottlenecks array and display each warning</subtask>
        <subtask id="6.4">Style with bg-red-900/20, border-red-500, rounded styling</subtask>
        <subtask id="6.5">Display bottleneck.message with ⚠️ emoji prefix</subtask>
      </task>
      <task id="7" status="pending">Verify onAddToWorkout integration from Story 3.3 (AC: 5)
        <subtask id="7.1">Confirm Story 3.3's onAddToWorkout callback updates workout.sets</subtask>
        <subtask id="7.2">Test that adding exercise triggers useEffect with workout.sets dependency</subtask>
        <subtask id="7.3">Verify debounced API call fires 500ms after workout.sets changes</subtask>
        <subtask id="7.4">Test that removing exercise also triggers forecast update</subtask>
      </task>
      <task id="8" status="pending">Implement error handling (Error Handling)
        <subtask id="8.1">Add try/catch around fetch API call</subtask>
        <subtask id="8.2">Handle network errors with user-friendly message</subtask>
        <subtask id="8.3">Parse error from API response { error: "message" } format</subtask>
        <subtask id="8.4">Display error message in forecast panel</subtask>
        <subtask id="8.5">Ensure isForecastLoading set to false in finally block</subtask>
      </task>
      <task id="9" status="pending">Add comprehensive integration tests (Testing)
        <subtask id="9.1">Test API call triggered when workout.sets changes in planning mode</subtask>
        <subtask id="9.2">Test POST request body structure (exercises array with exerciseId, estimatedSets)</subtask>
        <subtask id="9.3">Test debouncing behavior (500ms delay, cancels previous calls)</subtask>
        <subtask id="9.4">Test response parsing and forecast display</subtask>
        <subtask id="9.5">Test color-coded fatigue display for each zone (green, yellow, red, dark red)</subtask>
        <subtask id="9.6">Test bottleneck warning rendering</subtask>
        <subtask id="9.7">Test loading state (Calculating... message displayed)</subtask>
        <subtask id="9.8">Test error handling (network error, 500 error)</subtask>
        <subtask id="9.9">Test empty workout handling (no API call, show empty state)</subtask>
        <subtask id="9.10">Test cleanup on unmount (debounce.cancel() called)</subtask>
        <subtask id="9.11">Test mode switching (forecast only in planning mode, not executing mode)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <given>user is building a workout in WorkoutBuilder planning mode</given>
      <when>user adds/removes exercises or adjusts sets</when>
      <then>frontend calls POST /api/forecast/workout with exercises array containing exerciseId and estimatedSets</then>
    </criterion>
    <criterion id="2">
      <given>API request sent</given>
      <when>response received</when>
      <then>receives forecast object with muscle fatigue percentages, warnings array, and bottlenecks array with muscle, projectedFatigue, and message fields</then>
    </criterion>
    <criterion id="3">
      <given>forecast data received</given>
      <when>rendering UI</when>
      <then>displays predicted fatigue percentages next to each muscle in forecast panel</then>
    </criterion>
    <criterion id="4">
      <given>bottlenecks exist in response</given>
      <when>rendering warnings</when>
      <then>highlights bottleneck warnings (muscles exceeding 100% fatigue) in red</then>
    </criterion>
    <criterion id="5">
      <given>user modifies workout</given>
      <when>changes occur</when>
      <then>updates forecast in real-time with debounced API calls (500ms delay after last change)</then>
    </criterion>
    <criterion id="6">
      <given>forecast data available</given>
      <when>rendering muscle fatigue</when>
      <then>shows color-coded preview: Green (0-60%), Yellow (61-90%), Red (91-100%), Dark red (&gt;100%)</then>
    </criterion>
    <criterion id="7">
      <given>bottleneck detected</given>
      <when>rendering alert</when>
      <then>displays critical bottleneck alerts with specific messaging like "⚠️ Hamstrings would reach 115% - risk of overtraining"</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 3: Frontend Intelligence Integration</title>
        <section>Story 3.4: Connect WorkoutBuilder to Forecast API</section>
        <snippet>Replace local calculateForecastedMuscleStates() at line 253 with API call pattern. Use debounced fetch (500ms) triggered by useEffect watching workout.sets. Display color-coded forecast panel with bottleneck warnings.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 2: API Integration Layer</title>
        <section>Story 2.4: Implement Workout Forecast Endpoint</section>
        <snippet>POST /api/forecast/workout endpoint returns forecast object with muscle fatigue percentages, warnings array, and bottlenecks array. Implemented and tested in Story 2.4.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decisions</title>
        <section>API URL Pattern and Component Structure</section>
        <snippet>Component structure: WorkoutBuilder.tsx uses React useState hooks (NO Context/Redux). API pattern: /api/resource/:id/action. Component-local state management throughout.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/2-4-implement-workout-forecast-endpoint.md</path>
        <title>Story 2.4: Forecast Endpoint Implementation</title>
        <section>Dev Notes and API Documentation</section>
        <snippet>Endpoint returns current muscle states, predicted fatigue deltas, projected totals, bottleneck warnings with severity levels. No database writes during forecast.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/3-3-connect-exerciserecommendations-to-recommendation-api.md</path>
        <title>Story 3.3: Frontend Integration Pattern</title>
        <section>Dev Notes - Learnings from Previous Story</section>
        <snippet>Frontend integration pattern: useState hooks for data/loading/error state, fetch API with try/catch, component-local state (no global state). onAddToWorkout callback MUST update workout.sets for Story 3.4's useEffect to trigger.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>components/WorkoutBuilder.tsx</path>
        <kind>component</kind>
        <symbol>WorkoutBuilder</symbol>
        <lines>1-1300</lines>
        <reason>Primary component to modify - contains mode state (line 75), planning mode infrastructure (line 76), and calculateForecastedMuscleStates() function at line 256 that needs API replacement</reason>
      </artifact>
      <artifact>
        <path>components/WorkoutBuilder.tsx</path>
        <kind>function</kind>
        <symbol>calculateForecastedMuscleStates</symbol>
        <lines>256-290</lines>
        <reason>Local forecast calculation function to REPLACE with API call to /api/forecast/workout. Currently calculates client-side - needs server-side integration</reason>
      </artifact>
      <artifact>
        <path>api.ts</path>
        <kind>interface</kind>
        <symbol>WorkoutForecastRequest</symbol>
        <lines>497-503</lines>
        <reason>TypeScript interface for API request structure - defines exercises array with exerciseId, weight, reps fields</reason>
      </artifact>
      <artifact>
        <path>api.ts</path>
        <kind>interface</kind>
        <symbol>WorkoutForecastResponse</symbol>
        <lines>505-510</lines>
        <reason>TypeScript interface for API response structure - defines currentFatigue, predictedFatigue, finalFatigue, and warnings. Note: Story expects forecast, bottlenecks fields - may need interface update</reason>
      </artifact>
      <artifact>
        <path>api.ts</path>
        <kind>function</kind>
        <symbol>forecastWorkout</symbol>
        <lines>512-519</lines>
        <reason>Existing API helper function for calling /api/forecast/workout endpoint - can be used or replaced with fetch call</reason>
      </artifact>
      <artifact>
        <path>types.ts</path>
        <kind>enum</kind>
        <symbol>Muscle</symbol>
        <lines>2-16</lines>
        <reason>Muscle enum defining 13 muscle groups used throughout app - forecast response uses Record&lt;Muscle, number&gt; for fatigue percentages</reason>
      </artifact>
      <artifact>
        <path>components/__tests__/ExerciseRecommendations.integration.test.tsx</path>
        <kind>test</kind>
        <symbol>ExerciseRecommendations integration tests</symbol>
        <lines>1-300</lines>
        <reason>Example integration test from Story 3.3 showing Vitest + React Testing Library pattern for API integration testing</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="react" version="^19.2.0">Core React library for component development</package>
        <package name="react-dom" version="^19.2.0">React DOM rendering</package>
        <package name="react-router-dom" version="^6.30.1">Navigation and routing</package>
        <package name="vitest" version="^4.0.3">Test framework for integration tests</package>
        <package name="@testing-library/react" version="^16.3.0">React Testing Library for component testing</package>
        <package name="@testing-library/user-event" version="^14.6.1">User interaction simulation for tests</package>
        <package name="typescript" version="~5.8.2">TypeScript for type safety</package>
        <package name="lodash" version="NEEDED">Debounce utility - check if installed, may need: npm install lodash @types/lodash</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Component-local state management using React useState hooks - NO Context or Redux</constraint>
    <constraint>Replace local calculateForecastedMuscleStates() function at line 256 with API call pattern</constraint>
    <constraint>Debounce API calls with 500ms delay to prevent excessive requests during rapid changes</constraint>
    <constraint>Forecast only active when mode === 'planning', not in 'executing' mode</constraint>
    <constraint>CRITICAL DEPENDENCY: Story 3.3's onAddToWorkout callback MUST update workout.sets state for useEffect to trigger</constraint>
    <constraint>Use Fetch API with try/catch error handling (matching Stories 3.1, 3.2, 3.3 pattern)</constraint>
    <constraint>Display loading state with "Calculating..." message during API call</constraint>
    <constraint>Show empty state "Add exercises to see forecast" when no workout.sets exist</constraint>
    <constraint>Color-code fatigue display: Green (0-60%), Yellow (61-90%), Red (91-100%), Dark Red (&gt;100%)</constraint>
    <constraint>Display bottleneck warnings with emoji prefix (⚠️) and specific messaging</constraint>
    <constraint>Clean up debounce function on component unmount to prevent memory leaks</constraint>
    <constraint>Testing framework: Vitest with React Testing Library (matching Epic 3 pattern)</constraint>
    <constraint>Test debouncing behavior: verify 500ms delay, verify cancellation on rapid changes</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>POST /api/forecast/workout</name>
      <kind>REST endpoint</kind>
      <signature>Request: { exercises: Array&lt;{ exerciseId: string, estimatedSets: Array&lt;{ reps: number, weight: number }&gt; }&gt; } | Response: { forecast: Record&lt;Muscle, number&gt;, warnings: string[], bottlenecks: Array&lt;{ muscle: Muscle, projectedFatigue: number, message: string }&gt; }</signature>
      <path>backend/server.ts (implemented in Story 2.4)</path>
    </interface>
    <interface>
      <name>WorkoutForecastRequest</name>
      <kind>TypeScript interface</kind>
      <signature>interface WorkoutForecastRequest { exercises: Array&lt;{ exerciseId: string; weight: number; reps: number; }&gt;; }</signature>
      <path>api.ts:497-503</path>
    </interface>
    <interface>
      <name>WorkoutForecastResponse</name>
      <kind>TypeScript interface</kind>
      <signature>interface WorkoutForecastResponse { currentFatigue: Record&lt;string, number&gt;; predictedFatigue: Record&lt;string, number&gt;; finalFatigue: Record&lt;string, number&gt;; warnings: string[]; } | NOTE: Story expects 'forecast' and 'bottlenecks' fields - may need update</signature>
      <path>api.ts:505-510</path>
    </interface>
    <interface>
      <name>BuilderMode</name>
      <kind>TypeScript type</kind>
      <signature>type BuilderMode = 'planning' | 'executing';</signature>
      <path>components/WorkoutBuilder.tsx:25</path>
    </interface>
    <interface>
      <name>PlanningMode</name>
      <kind>TypeScript type</kind>
      <signature>type PlanningMode = 'forward' | 'target';</signature>
      <path>components/WorkoutBuilder.tsx:26</path>
    </interface>
    <interface>
      <name>onAddToWorkout callback</name>
      <kind>Function signature from Story 3.3</kind>
      <signature>(exercise: Exercise) =&gt; void | CRITICAL: Must update WorkoutBuilder's workout.sets state to trigger forecast useEffect</signature>
      <path>components/ExerciseRecommendations.tsx (Story 3.3 integration)</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Testing framework: Vitest with React Testing Library. Pattern established in Stories 3.1, 3.2, 3.3.
      Mock fetch API for controlled test scenarios. Test loading states, error states, and success states.
      Test component integration (props, callbacks, state updates). Edge case coverage: network errors, malformed data, empty responses.
      NEW for this story: Test debouncing behavior (delay verification, cancellation on rapid changes, cleanup on unmount).
      Test file naming: ComponentName.integration.test.tsx or ComponentName.test.tsx in components/__tests__/ directory.
    </standards>
    <locations>
      <location>components/__tests__/*.test.tsx</location>
      <location>components/__tests__/*.integration.test.tsx</location>
    </locations>
    <ideas>
      <idea ac="1,2">Test API call triggered when workout.sets changes in planning mode (verify fetch called with correct endpoint and body structure)</idea>
      <idea ac="1">Test POST request body structure (exercises array with exerciseId and estimatedSets arrays containing reps/weight)</idea>
      <idea ac="5">Test debouncing behavior: verify 500ms delay between rapid changes, verify previous calls cancelled, verify debounce.cancel() called on unmount</idea>
      <idea ac="2,3">Test response parsing and forecast display (verify muscle fatigue percentages rendered correctly from API response)</idea>
      <idea ac="6">Test color-coded fatigue display for each zone: green (0-60%), yellow (61-90%), red (91-100%), dark red (&gt;100%)</idea>
      <idea ac="4,7">Test bottleneck warning rendering (verify warnings displayed with emoji prefix and specific messages)</idea>
      <idea ac="3">Test loading state (verify "Calculating..." message displayed when isForecastLoading === true)</idea>
      <idea>Test error handling (network error, 500 error, malformed response - verify error message displayed)</idea>
      <idea ac="1">Test empty workout handling (no API call when workout.sets is empty, show empty state message)</idea>
      <idea ac="5">Test mode switching (forecast only updates in planning mode, not executing mode - verify no API call when mode !== 'planning')</idea>
      <idea ac="5">Test Story 3.3 integration: verify onAddToWorkout callback updates workout.sets, triggering forecast useEffect</idea>
    </ideas>
  </tests>
</story-context>
